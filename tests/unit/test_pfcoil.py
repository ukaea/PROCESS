"""Unit tests for pfcoil.f90."""

from typing import NamedTuple

import numpy as np
import pytest
from numpy.testing import assert_array_almost_equal

from process.cs_fatigue import CsFatigue
from process.data_structure import build_variables as bv
from process.data_structure import pfcoil_variables
from process.data_structure import tfcoil_variables as tfv
from process.pfcoil import CSCoil, PFCoil, calculate_b_field_at_point, rsid


@pytest.fixture
def pfcoil():
    """Fixture to create a PFCoil object.

    :return: an instance of PFCoil
    :rtype: process.pfcoil.PFCoil
    """

    return PFCoil(cs_fatigue=CsFatigue())


@pytest.fixture
def cs_coil():
    """Fixture to create a CSCoil object.

    :return: an instance of CSCoil
    :rtype: process.pfcoil.CSCoil
    """
    return CSCoil(cs_fatigue=CsFatigue())


def test_init_pfcoil(pfcoil):
    """Test initialisation of Fortran module variables.

    :param pfcoil: PFCoil object
    :type pfcoil: process.pfcoil.PFCoil
    """
    # Test a selection of module variables
    assert pfcoil_variables.ssq0 == 0.0
    assert pfcoil_variables.cslimit == 0
    assert pfcoil_variables.nef == 0


def test_rsid(pfcoil):
    """Test rsid subroutine.

    rsid() requires specific arguments in order to work; these were discovered
    using gdb to break on the first subroutine call when running the baseline
    2018 IN.DAT.

    :param pfcoil: PFCoil object
    :type pfcoil: process.pfcoil.PFCoil
    """
    nptsmx = 32
    npts = 32
    brin = np.zeros(nptsmx)
    bzin = np.zeros(nptsmx)
    nfix = 14
    n_pf_coil_groups = 4
    ccls = np.array([
        14742063.826112622,
        20032681.634901665,
        580406.62653667293,
        429746.74788703024,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
    ])
    brssq = 1.7347234759768071e-18
    brnrm = 0

    bzssq = 164.92735114640433
    bznrm = -0.12924373312291032
    ssq = 0
    bfix = np.array([
        -2.7755575615628914e-17,
        -2.7755575615628914e-17,
        -2.0816681711721685e-17,
        -6.2450045135165055e-17,
        4.8572257327350599e-17,
        8.3266726846886741e-17,
        6.9388939039072284e-18,
        4.163336342344337e-17,
        2.0816681711721685e-17,
        1.3877787807814457e-17,
        -2.7755575615628914e-17,
        -2.7755575615628914e-17,
        1.3877787807814457e-17,
        3.1225022567582528e-17,
        -1.3877787807814457e-17,
        -3.4694469519536142e-18,
        6.9388939039072284e-18,
        -2.7755575615628914e-17,
        3.4694469519536142e-18,
        2.4286128663675299e-17,
        4.5102810375396984e-17,
        1.3877787807814457e-17,
        1.0408340855860843e-17,
        -6.9388939039072284e-18,
        1.3877787807814457e-17,
        1.7347234759768071e-17,
        2.7755575615628914e-17,
        -6.9388939039072284e-18,
        -1.7347234759768071e-18,
        2.2551405187698492e-17,
        1.0408340855860843e-17,
        1.7347234759768071e-18,
        -0.3537283013510894,
        -0.34304632621819631,
        -0.33256831505329448,
        -0.32230579414441957,
        -0.31226839635096026,
        -0.30246398750499448,
        -0.29289879096799015,
        -0.283577511993583,
        -0.27450346141940818,
        -0.26567867760304337,
        -0.25710404545385829,
        -0.24877941153731781,
        -0.24070369440957809,
        -0.23287498952924324,
        -0.22529066827105398,
        -0.21794747072660745,
        -0.21084159211740575,
        -0.20396876276560738,
        -0.19732432166849023,
        -0.1909032838051643,
        -0.18470040136999577,
        -0.17871021917825794,
        -0.17292712452755193,
        -0.16734539182494823,
        -0.16195922230675014,
        -0.15676277918619164,
        -0.15175021856634768,
        -0.1469157164516591,
        -0.14225349218352654,
        -0.13775782861391137,
        -0.13342308931695324,
        -0.12924373312291032,
        6.9533558060713876e-310,
        3.7299818735403947e-315,
        1.2461007517394582e-316,
        9.3633631912996395e-97,
        6.9533558060721781e-310,
        6.9533472776350595e-310,
        6.9533558069464767e-310,
        6.9533558071276999e-310,
        6.9533558060745496e-310,
        3.7299818735403947e-315,
    ])
    gmat = np.reshape(
        [
            -7.5172758677351012e-09,
            -7.5647853749229854e-09,
            -7.5997238671870255e-09,
            -7.6223532503471955e-09,
            -7.632981272566719e-09,
            -7.6319588203836032e-09,
            -7.6196767980524902e-09,
            -7.5965626403274021e-09,
            -7.5630765157560611e-09,
            -7.5197072828239948e-09,
            -7.4669682647618112e-09,
            -7.4053929104575667e-09,
            -7.3355304087267682e-09,
            -7.257941321277872e-09,
            -7.1731932962298625e-09,
            -7.0818569191945103e-09,
            -6.984501752975301e-09,
            -6.8816926101232378e-09,
            -6.773986095202415e-09,
            -6.6619274459294016e-09,
            -6.5460476946140002e-09,
            -6.4268611637803582e-09,
            -6.304863302684304e-09,
            -6.1805288648306937e-09,
            -6.0543104206590232e-09,
            -5.9266371943928248e-09,
            -5.7979142096894936e-09,
            -5.6685217251979314e-09,
            -5.5388149384199096e-09,
            -5.4091239343399337e-09,
            -5.2797538540809693e-09,
            -5.1509852582910393e-09,
            9.3492430453057107e-09,
            9.0085911649292264e-09,
            8.6689173990086107e-09,
            8.3309944868826759e-09,
            7.9955690099997426e-09,
            7.6633571228220887e-09,
            7.3350406224857193e-09,
            7.0112634126980615e-09,
            6.6926284084926325e-09,
            6.3796949185645214e-09,
            6.0729765313335842e-09,
            5.7729395199931187e-09,
            5.4800017709631934e-09,
            5.1945322297232159e-09,
            4.9168508482561741e-09,
            4.6472290095579218e-09,
            4.3858903970555656e-09,
            4.1330122704854838e-09,
            3.8887271048890237e-09,
            3.6531245459172901e-09,
            3.4262536325698331e-09,
            3.2081252377476782e-09,
            2.9987146774668041e-09,
            2.7979644411114181e-09,
            2.6057869975431741e-09,
            2.4220676350521897e-09,
            2.2466672968619253e-09,
            2.0794253780146199e-09,
            1.9201624538069016e-09,
            1.7686829143744347e-09,
            1.6247774844145175e-09,
            1.4882256112814138e-09,
            5.0000000000000003e-10,
            0.0,
            0.0,
            0.0,
            0.62007430335325187,
            0.63886443375789592,
            0.65765456416253987,
            0.67644469456718381,
            0.69523482497182787,
            0.71402495537647193,
            5.2231355975329339e-09,
            5.2711960625139632e-09,
            5.311576236174689e-09,
            5.3443982499402794e-09,
            5.3698063638504674e-09,
            5.3879658378724807e-09,
            5.3990616639723659e-09,
            5.4032971732511661e-09,
            5.400892534248167e-09,
            5.3920831599635704e-09,
            5.3771180422303474e-09,
            5.356258032750445e-09,
            5.3297740904008349e-09,
            5.2979455143168409e-09,
            5.2610581817914976e-09,
            5.2194028092188655e-09,
            5.1732732531934983e-09,
            5.1229648674991946e-09,
            5.0687729301276593e-09,
            5.0109911527105061e-09,
            4.9499102828790943e-09,
            4.8858168081356574e-09,
            4.8189917678740469e-09,
            4.7497096782738378e-09,
            4.6782375729467911e-09,
            4.6048341604722139e-09,
            4.5297490983470443e-09,
            4.4532223814171667e-09,
            4.3754838415645443e-09,
            4.2967527543090933e-09,
            4.2172375470486835e-09,
            4.1371356029042306e-09,
            7.3034474444379776e-09,
            7.0812955124293447e-09,
            6.8590392930553784e-09,
            6.637109454243546e-09,
            6.4159243604656496e-09,
            6.1958883508443865e-09,
            5.977390136484671e-09,
            5.7608013330362493e-09,
            5.5464751423657795e-09,
            5.3347451948431544e-09,
            5.1259245611905599e-09,
            4.920304940172507e-09,
            4.7181560256885825e-09,
            4.5197250541359462e-09,
            4.3252365302988979e-09,
            4.1348921275568188e-09,
            3.9488707559297158e-09,
            3.7673287894451147e-09,
            3.5904004425437655e-09,
            3.4181982837673617e-09,
            3.2508138738027688e-09,
            3.0883185140970476e-09,
            2.9307640917016306e-09,
            2.7781840057391115e-09,
            2.6305941608925159e-09,
            2.4879940135710844e-09,
            2.350367656878777e-09,
            2.2176849311714561e-09,
            2.0899025478031295e-09,
            1.9669652145980284e-09,
            1.8488067526120262e-09,
            1.7353511948326436e-09,
            0.0,
            5.0000000000000003e-10,
            0.0,
            0.0,
            2.0105439532969078,
            2.0293340837015519,
            2.0481242141061959,
            2.06691434451084,
            2.0857044749154836,
            2.1044946053201277,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            7.0796316577555638e-08,
            7.1129087582983064e-08,
            7.147530005952651e-08,
            7.1835291378861722e-08,
            7.2209413650970811e-08,
            7.2598033968782154e-08,
            7.3001534603899801e-08,
            7.3420313139375502e-08,
            7.3854782522663518e-08,
            7.4305371018539935e-08,
            7.4772522037762321e-08,
            7.5256693812462047e-08,
            7.5758358883548959e-08,
            7.6278003358579342e-08,
            7.6816125890374903e-08,
            7.7373236316910148e-08,
            7.794985389128976e-08,
            7.8546505016623934e-08,
            7.9163720383809578e-08,
            7.9802031390073597e-08,
            8.04619656919452e-08,
            8.1144041717279125e-08,
            8.1848761926055365e-08,
            8.2576604567746986e-08,
            8.3328013632647066e-08,
            8.4103386633970471e-08,
            8.4903059784765231e-08,
            8.5727290046267352e-08,
            8.6576233419482551e-08,
            8.7449918726163595e-08,
            8.8348215975168323e-08,
            8.9270798231114913e-08,
            0.0,
            0.0,
            1.0000000000000001e-09,
            0.0,
            3.4010136032405636,
            3.4198037336452076,
            3.4385938640498517,
            3.4573839944544953,
            3.4761741248591393,
            3.4949642552637834,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            5.4813906485884661e-08,
            5.4774799801531037e-08,
            5.4730107534112241e-08,
            5.4679342869890839e-08,
            5.4621991000204629e-08,
            5.4557508051195313e-08,
            5.4485320038324824e-08,
            5.4404821860060912e-08,
            5.4315376347382176e-08,
            5.4216313388257004e-08,
            5.4106929148993813e-08,
            5.3986485417343063e-08,
            5.385420909545036e-08,
            5.3709291874199423e-08,
            5.3550890124120389e-08,
            5.3378125041838762e-08,
            5.3190083094948163e-08,
            5.2985816812140533e-08,
            5.2764345969327501e-08,
            5.2524659226222869e-08,
            5.2265716271286847e-08,
            5.1986450535883233e-08,
            5.1685772540768793e-08,
            5.1362573939377029e-08,
            5.1015732322501792e-08,
            5.064411684761966e-08,
            5.0246594752874167e-08,
            4.982203881031119e-08,
            4.9369335764923977e-08,
            4.8887395795052735e-08,
            4.8375163015320454e-08,
            4.7831627025242824e-08,
            0.0,
            0.0,
            0.0,
            1.0000000000000001e-09,
            25.13158605014862,
            25.025324207304788,
            24.917316885291271,
            24.807573484682806,
            24.696103604411817,
            24.582917043712971,
            24.468023804127618,
            24.351434091569946,
            24.233158318456688,
            24.113207105902351,
            23.991591285982111,
            23.868321904064398,
            23.743410221215505,
            23.616867716678527,
            23.488706090429144,
            23.358937265810724,
            23.227573392251532,
            23.094626848066817,
            22.960110243348691,
            22.824036422946961,
            22.686418469544087,
            22.547269706827709,
            22.406603702764219,
            22.264434272977205,
            22.120775484234603,
            21.975641658048701,
            21.829047374393273,
            21.68100747554244,
            21.531537070035913,
            21.380651536775758,
            21.228366529259795,
            21.074697979957286,
            20.919662104832742,
            20.763275408023894,
            20.605554686680403,
            20.446517035970114,
            20.286179854260013,
            20.124560848479536,
            19.961678039674222,
            19.79754976875827,
            19.632194702474806,
            19.46563183957354,
            19.297880517215713,
            19.128960417617037,
            18.958891574939837,
            18.787694382446446,
            18.615389599926406,
            18.441998361411049,
            18.267542183189661,
            18.092042972142579,
            17.915523034407233,
            17.738005084394501,
            17.559512254173683,
            17.380068103245705,
            17.199696628725381,
            17.018422275955185,
            16.836269949574284,
            16.653265025068411,
            16.469433360827917,
            16.284801310743315,
            16.099395737369765,
            15.91324402569419,
            15.726374097541433,
            15.538814426658366,
            15.350594054518114,
            15.161742606889613,
            14.972290311221556,
            14.782268014893495,
            14.591707204391369,
            14.400640025469301,
            14.209099304364994,
            14.017118570141474,
            13.824732078234575,
            13.631974835292443,
            13.438882625401121,
            13.245492037798916,
            13.051840496191812,
            12.857966289792909,
            12.663908606220593,
            12.469707566403567,
            12.275404261655641,
            12.081040793099827,
            11.886660313639975,
            11.69230707269924,
            11.498026463968529,
            11.303865076434823,
            11.109870748989817,
            10.916092628954088,
            10.722581234891317,
            10.529388524132496,
            10.33656796548159,
            10.144174617633903,
            9.9522652139068501,
            9.760898253962452,
            9.5701341032929843,
            9.3800351013488772,
            9.1906656793134758,
            9.0020924886770519,
            8.8143845419364979,
            8.6276133669531312,
            8.4418531767464202,
            8.2571810567943729,
            8.0736771722637322,
            7.8914249980183939,
            7.7105115747715134,
            7.5310277953788134,
            7.3530687260479235,
            7.1767339682022557,
            7.0021280679401254,
            6.8293609815428935,
            6.658548607405363,
            6.4898133972199918,
            6.32328506242591,
            6.1591013960900813,
            5.9974092358858009,
            5.8383656011988148,
            5.6821390473972109,
            5.5289112941053018,
            5.3788792036934145,
            5.2322572139005272,
            5.0892803689803294,
            4.9502081543226453,
            4.8153294326235061,
            4.6849689274151469,
            4.5594959428242898,
            4.4393364257562693,
            4.3249902307904238,
            4.2170568981487575,
            4.1162762690671855,
            4.0235971899548915,
            3.9403058021811721,
            3.8683035615989403,
            3.8108886937263349,
            3.7775374842470044,
            3.4710760272264269,
            3.1646145702058428,
            2.8581531131852587,
            2.5516916561646745,
            2.2452301991440899,
            1.9387687421235056,
            1.6323072851029214,
            1.3258458280823373,
            1.0193843710617527,
            0.71292291404116859,
            0.40646145702058434,
            0.10000000000000001,
            9.7755857974627389,
            9.7752508937483391,
            9.774692720891009,
            9.7739112788907452,
            9.7729065677475511,
            9.7716785874614214,
            9.7702273380323632,
            9.7685528194603712,
            9.7666550317454472,
            9.7645339748875912,
            9.7621896488868014,
            9.7596220537430796,
            9.7568311894564275,
            9.7538170560268416,
            9.7505796534543254,
            9.7471189817388737,
            9.7434350408804917,
            9.7395278308791777,
            9.7353973517349299,
            9.7310436034477519,
            9.72646658601764,
            9.7216662994445961,
            9.7166427437286185,
            9.7113959188697123,
            9.7059258248678706,
            9.7002324617230968,
            9.6943158294353928,
            9.688175928004755,
            9.6818127574311852,
            9.6752263177146851,
            9.6684166088552512,
            9.6613836308528835,
            9.6541273837075856,
            9.6466478674193539,
            9.6389450819881919,
            9.6310190274140961,
            9.6228697036970683,
            9.6144971108371085,
            9.6059012488342166,
            9.5970821176883927,
            9.588039717399635,
            9.5787740479679453,
            9.5692851093933253,
            9.5595729016757716,
            9.5496374248152858,
            9.5394786788118697,
            9.5290966636655181,
            9.5184913793762345,
            9.5076628259440188,
            9.4966110033688729,
            9.4853359116507932,
            9.4738375507897832,
            9.4621159207858376,
            9.4501710216389618,
            9.4380028533491522,
            9.4256114159164124,
            9.4129967093407405,
            9.4001587336221348,
            9.3870974887605971,
            9.3738129747561274,
            9.3603051916087257,
            9.3465741393183919,
            9.3326198178851261,
            9.3184422273089247,
            9.3040413675897948,
            9.2894172387277312,
            9.2745698407227355,
            9.2594991735748078,
            9.2442052372839481,
            9.2286880318501545,
            9.2129475572734307,
            9.1969838135537749,
            9.1807968006911853,
            9.1643865186856637,
            9.14775296753721,
            9.1308961472458225,
            9.1138160578115048,
            9.0965126992342551,
            9.0789860715140716,
            9.061236174650956,
            9.0432630086449102,
            9.0250665734959306,
            9.0066468692040189,
            8.9880038957691752,
            8.9691376531913978,
            8.9500481414706883,
            8.9307353606070485,
            8.911199310600475,
            8.8914399914509694,
            8.8714574031585318,
            8.8512515457231622,
            8.8308224191448588,
            8.8101700234236251,
            8.7892943585594594,
            8.7681954245523599,
            8.7468732214023284,
            8.725327749109363,
            8.7035590076734675,
            8.6815669970946399,
            8.6593517173728802,
            8.6369131685081868,
            8.6142513505005631,
            8.5913662633500039,
            8.5682579070565161,
            8.5449262816200946,
            8.5213713870407393,
            8.4975932233184537,
            8.4735917904532361,
            8.4493670884450864,
            8.4249191172940012,
            8.4002478769999875,
            8.3753533675630401,
            8.3502355889831605,
            8.3248945412603472,
            8.2993302243946037,
            8.2735426383859281,
            8.2475317832343187,
            8.2212976589397773,
            8.1948402655023038,
            8.1681596029218984,
            8.1412556711985609,
            8.1141284703322896,
            8.086778000323088,
            8.0592042611709527,
            8.0314072528758871,
            8.0033869754378877,
            7.9751434288569545,
            7.946676613133091,
            7.9179865282662956,
            7.8890731742565681,
            7.8599365511039059,
            7.8305766588083143,
            7.8009934973697881,
            7.7711870667883316,
            7.7411573670639413,
            7.7109043981966199,
            7.6804281601863664,
            7.6497286530331801,
            7.6188058767370617,
            7.5876598312980104,
            7.5562905167160279,
            7.5246979329911108,
            7.4928820801232634,
            7.460842958112484,
            7.4285805669587708,
            7.3960949066621273,
            7.3633859772225492,
            7.3304537786400417,
            7.2972983109146003,
            7.2639195740462261,
            7.2303175680349208,
            7.1964922928806816,
            7.1624437485835113,
            7.1281719351434081,
            7.0936768525603737,
            7.0589585008344073,
            7.0240168799655063,
            6.9888519899536758,
            6.9534638307989116,
            6.9178524025012154,
            6.8820177050605871,
            6.8459597384770268,
            6.8096785027505335,
            6.7731739978811083,
            6.7364462238687519,
            6.6994951807134608,
            6.6623208684152386,
            6.6249232869740844,
            6.5873024363899981,
            6.549458316662979,
            6.5113909277930277,
            6.4731002697801445,
            6.4345863426243284,
            6.3958491463255811,
            6.3568886808839,
            6.3177049462992887,
            6.2782979425717436,
            6.2386676697012664,
            6.1988141276878572,
            6.158737316531516,
            6.1184372362322419,
            6.0779138867900357,
            6.0371672682048976,
            5.9961973804768274,
            5.9550042236058234,
            5.9135877975918882,
            5.8719481024350211,
            5.8300851381352228,
            5.630033197120782,
            5.4299812561063376,
            5.2299293150918933,
            5.0298773740774489,
            4.8298254330630046,
            4.6297734920485603,
            4.4297215510341159,
            4.2296696100196716,
            4.0296176690052263,
            3.8295657279907829,
            3.6295137869763385,
            3.4294618459618942,
            0.99993750390600578,
            0.99975006248437881,
            0.99943781622837147,
            0.99900099900099915,
            0.99843993759750393,
            0.99775505113494634,
            0.9969468502710449,
            0.99601593625498008,
            0.99496299981344449,
            0.99378881987577627,
            0.9924942621425471,
            0.99108027750247785,
            0.98954790030304907,
            0.98789824648061242,
            0.98613251155624027,
            0.98425196850393704,
            0.98225796549818889,
            0.98015192354814984,
            0.97793533402603749,
            0.97560975609756106,
            0.97317681406240497,
            0.97063819461295786,
            0.96799564401960192,
            0.96525096525096521,
            0.96240601503759393,
            0.95946270088750307,
            0.95642297806204801,
            0.95328884652049573,
            0.95006234784157706,
            0.94674556213017758,
            0.94334060491716298,
            0.93984962406015038,
            0.93627479665281765,
            0.93261832595010496,
            0.92888243831640049,
            0.92506938020351526,
            0.92118141516494911,
            0.91722082091263479,
            0.91318988642200782,
            0.90909090909090906,
            0.90492619195746837,
            0.90069804098176087,
            0.89640876239565237,
            0.89206066012488849,
            0.8876560332871013,
            0.88319717376904394,
            0.87868636388599042,
            0.87412587412587417,
            0.86951796098038148,
            0.86486486486486491,
            0.86016880812859531,
            0.85543199315654406,
            0.85065660056355996,
            0.84584478748149716,
            0.84099868593955329,
            0.83612040133779264,
            0.83121201101355924,
            0.82627556290022719,
            0.82131307427750111,
            0.81632653061224481,
            0.81131788448861619,
            0.80628905462608336,
            0.80124192498372471,
            0.79617834394904463,
            0.7911001236093943,
            0.78600903910394959,
            0.78090682805407774,
            0.77579519006982145,
            0.77067578633013822,
            0.76555023923444976,
            0.76042013212299797,
            0.75528700906344415,
            0.75015237470111118,
            0.74501769417023656,
            0.73988439306358378,
            0.73475385745775168,
            0.72962743399151797,
            0.72450642999456616,
            0.71939211366395395,
            0.71428571428571419,
            0.70918842249900271,
            0.70410139060024657,
            0.69902573288479186,
            0.69396252602359476,
            0.68891280947255107,
            0.68387758591212167,
            0.67885782171496456,
            0.67385444743935308,
            0.66886835834622305,
            0.66390041493775931,
            0.65895144351550594,
            0.65402223675604976,
            0.6491135543024058,
            0.64422612336930263,
            0.63936063936063936,
            0.63451776649746194,
            0.62969813845487821,
            0.62490235900640523,
            0.62013100267431487,
            0.61538461538461542,
            0.61066371512537687,
            0.60596879260718073,
            0.60130031192453681,
            0.59665871121718372,
        ],
        (74, 10),
        order="F",
    )

    brssq_exp = 0.0005682062650683896
    brnrm_exp = 0.0
    bzssq_exp = 7.188474446020582e-05
    bznrm_exp = 0.0
    ssq_exp = 0.0006400910095285954

    brssq, brnrm, bzssq, bznrm, ssq = rsid(
        npts, brin, bzin, nfix, n_pf_coil_groups, ccls, bfix, gmat
    )

    assert brssq == pytest.approx(brssq_exp)
    assert brnrm == pytest.approx(brnrm_exp)
    assert bzssq == pytest.approx(bzssq_exp)
    assert bznrm == pytest.approx(bznrm_exp)
    assert ssq == pytest.approx(ssq_exp)


def test_bfield():
    """Test bfield function.

    calculate_b_field_at_point() requires specific arguments in order to work; these were discovered
    using gdb to break on the first subroutine call when running the baseline
    2018 IN.DAT.

    :param pfcoil: PFCoil object
    :type pfcoil: process.pfcoil.PFCoil
    """
    rc = np.array([
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
        2.6084100000000001,
    ])
    zc = np.array([
        0.58327007281470211,
        1.7498102184441064,
        2.9163503640735104,
        4.0828905097029144,
        5.2494306553323193,
        6.4159708009617233,
        7.5825109465911273,
        -0.58327007281470211,
        -1.7498102184441064,
        -2.9163503640735104,
        -4.0828905097029144,
        -5.2494306553323193,
        -6.4159708009617233,
        -7.5825109465911273,
    ])
    cc = np.array([
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
        12444820.564847374,
    ])
    rp = 6.0223258064516134
    zp = 0

    xc_exp = np.array([
        2.36278088e-06,
        2.05233185e-06,
        1.62139434e-06,
        1.22298265e-06,
        9.08339602e-07,
        6.75290638e-07,
        5.06601647e-07,
        2.36278088e-06,
        2.05233185e-06,
        1.62139434e-06,
        1.22298265e-06,
        9.08339602e-07,
        6.75290638e-07,
        5.06601647e-07,
    ])
    br_exp = -2.7755575615628914e-17
    bz_exp = -0.3537283013510894
    psi_exp = 232.7112153010189

    xc, br, bz, psi = calculate_b_field_at_point(rc, zc, cc, rp, zp)

    assert_array_almost_equal(xc, xc_exp)
    assert pytest.approx(br) == br_exp
    assert pytest.approx(bz) == bz_exp
    assert pytest.approx(psi) == psi_exp


class BfmaxTestAsset(NamedTuple):
    """Test asset for single test case of test_bfmax().

    :param NamedTuple: Typed version of namedtuple
    :type NamedTuple: typing.NamedTuple

    TODO What's the best way to doc a NamedTuple?
    :a: solenoid inner radius (m)
    :type a: float
    :h: solenoid half height (m)
    :type h: float
    :bfmax_exp: expected returned value of bfmax, the maximum field of a
    solenoid
    :type bfmax_exp: float
    """

    a: float
    h: float
    bfmax_exp: float


@pytest.mark.parametrize(
    "test_asset",
    [
        BfmaxTestAsset(a=2.0, h=8.0, bfmax_exp=2.461485e1),
        BfmaxTestAsset(a=2.0, h=4.1, bfmax_exp=2.2072637e1),
        BfmaxTestAsset(a=2.0, h=2.1, bfmax_exp=1.803889e1),
        BfmaxTestAsset(a=2.0, h=1.6, bfmax_exp=1.693509e1),
        BfmaxTestAsset(a=2.0, h=1.0, bfmax_exp=1.4601048e1),
    ],
)
def test_bfmax(cs_coil, test_asset):
    """Test calculate_cs_self_peak_magnetic_field() function.

    :param cs_coil: CSCoil object
    :type cs_coil: process.pfcoil.CSCoil
    :param test_asset: arguments and expected return value for single test case
    :type test_asset: BfmaxTestAsset
    """
    rj = 2.0e7
    b = 3.0

    bfmax = cs_coil.calculate_cs_self_peak_magnetic_field(
        rj, test_asset.a, b, test_asset.h
    )

    assert pytest.approx(bfmax) == test_asset.bfmax_exp


def test_waveform(monkeypatch, pfcoil):
    """Test waveform subroutine.

    waveform() requires specific mocked variables in order to work; these were
    discovered using gdb to break on the first subroutine call when running the
    baseline 2018 IN.DAT.

    waveform() alters both c_pf_cs_coils_peak_ma and f_c_pf_cs_peak_time_array in the pfcoil_variables module, so
    these are asserted on.
    :param monkeypatch: mocking fixture
    :type monkeypatch: _pytest.monkeypatch.MonkeyPatch
    :param pfcoil: PFCoil object
    :type pfcoil: process.pfcoil.PFCoil
    """
    ngc2 = 22
    monkeypatch.setattr(pfcoil_variables, "c_pf_cs_coils_peak_ma", np.zeros(ngc2))
    monkeypatch.setattr(pfcoil_variables, "n_cs_pf_coils", 7)
    monkeypatch.setattr(
        pfcoil_variables, "f_c_pf_cs_peak_time_array", np.zeros((ngc2, 6), order="F")
    )
    monkeypatch.setattr(
        pfcoil_variables,
        "c_pf_cs_coil_pulse_start_ma",
        np.array([
            0.067422231232391661,
            -2.9167273287450968,
            -8.1098913365453491,
            -8.1098913365453491,
            -5.5984385047179153,
            -5.5984385047179153,
            -186.98751599968148,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        ]),
    )
    monkeypatch.setattr(
        pfcoil_variables,
        "c_pf_cs_coil_flat_top_ma",
        np.array([
            0.067422231232391661,
            -2.9167273287450968,
            -8.1098913365453491,
            -8.1098913365453491,
            -5.5984385047179153,
            -5.5984385047179153,
            -186.98751599968148,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        ]),
    )
    monkeypatch.setattr(
        pfcoil_variables,
        "c_pf_cs_coil_pulse_end_ma",
        np.array([
            14.742063826112622,
            20.032681634901664,
            0.58040662653667285,
            0.58040662653667285,
            0.42974674788703021,
            0.42974674788703021,
            174.22748790786324,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        ]),
    )

    ric_exp = np.array([
        14.74206383,
        20.03268163,
        -8.10989134,
        -8.10989134,
        -5.5984385,
        -5.5984385,
        -186.987516,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
    ])
    waves_exp = np.array(
        [
            [0.0, 0.00457346, 0.00457346, 0.00457346, 1.0, 0.0],
            [0.0, -0.14559845, -0.14559845, -0.14559845, 1.0, 0.0],
            [0.0, 1.0, 1.0, 1.0, -0.07156774, 0.0],
            [0.0, 1.0, 1.0, 1.0, -0.07156774, 0.0],
            [0.0, 1.0, 1.0, 1.0, -0.07676189, 0.0],
            [0.0, 1.0, 1.0, 1.0, -0.07676189, 0.0],
            [0.0, 1.0, 1.0, 1.0, -0.93176, 0.0],
            [1.0, 1.0, 1.0, 1.0, 1.0, 1.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
        ],
    )

    pfcoil.waveform()

    assert_array_almost_equal(pfcoil_variables.c_pf_cs_coils_peak_ma, ric_exp)
    assert_array_almost_equal(pfcoil_variables.f_c_pf_cs_peak_time_array, waves_exp)


def test_vsec(pfcoil, monkeypatch):
    """Test vsec subroutine.

    vsec() requires specific mocked variables in order to work; these were
    discovered using gdb to break on the first subroutine call when running the
    baseline 2018 IN.DAT.

    vsec() modifies many vars, so only a couple are asserted on.
    :param pfcoil: PFCoil object
    :type pfcoil: process.pfcoil.PFCoil
    :param monkeypatch: mocking fixture
    :type monkeypatch: _pytest.monkeypatch.MonkeyPatch
    """
    monkeypatch.setattr(bv, "iohcl", 1)
    monkeypatch.setattr(pfcoil_variables, "vs_pf_coils_total_ramp", 0.0)
    monkeypatch.setattr(pfcoil_variables, "vs_cs_pf_total_burn", 0.0)
    monkeypatch.setattr(pfcoil_variables, "n_cs_pf_coils", 7)
    monkeypatch.setattr(pfcoil_variables, "vs_cs_burn", 0.0)
    monkeypatch.setattr(
        pfcoil_variables,
        "c_pf_coil_turn",
        np.array(
            [
                [
                    [0.0],
                    [4.22000000e04],
                    [1.92999989e02],
                    [1.92999989e02],
                    [1.92999989e02],
                    [0.0],
                ],
                [
                    [0.0],
                    [4.22000000e04],
                    [-6.14425445e03],
                    [-6.14425445e03],
                    [-6.14425445e03],
                    [0.0],
                ],
                [
                    [0.0],
                    [3.02015879e03],
                    [-4.22000000e04],
                    [-4.22000000e04],
                    [-4.22000000e04],
                    [0.0],
                ],
                [
                    [0.0],
                    [3.02015879e03],
                    [-4.22000000e04],
                    [-4.22000000e04],
                    [-4.22000000e04],
                    [0.0],
                ],
                [
                    [0.0],
                    [3.30076148e03],
                    [-4.30000000e04],
                    [-4.30000000e04],
                    [-4.30000000e04],
                    [0.0],
                ],
                [
                    [0.0],
                    [3.30076148e03],
                    [-4.30000000e04],
                    [-4.30000000e04],
                    [-4.30000000e04],
                    [0.0],
                ],
                [
                    [0.0],
                    [4.00656800e04],
                    [-4.30000000e04],
                    [-4.30000000e04],
                    [-4.30000000e04],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [1.77213070e07],
                    [1.77213070e07],
                    [1.77213070e07],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
                [
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                    [0.0],
                ],
            ],
            order="F",
        ).squeeze(),
    )
    monkeypatch.setattr(pfcoil_variables, "vs_pf_coils_total_burn", 0.0)
    monkeypatch.setattr(pfcoil_variables, "vs_cs_ramp", 0.0)
    monkeypatch.setattr(pfcoil_variables, "vs_pf_coils_total_pulse", 0.0)
    monkeypatch.setattr(pfcoil_variables, "vs_cs_total_pulse", 0.0)
    monkeypatch.setattr(pfcoil_variables, "vs_cs_pf_total_ramp", 0.0)
    monkeypatch.setattr(pfcoil_variables, "vs_cs_pf_total_pulse", 0.0)
    monkeypatch.setattr(pfcoil_variables, "n_pf_cs_plasma_circuits", 8)
    monkeypatch.setattr(
        pfcoil_variables,
        "ind_pf_cs_plasma_mutual",
        np.array(
            [
                [
                    2.49332453e00,
                    4.46286166e-02,
                    2.38094100e-01,
                    1.57653632e-01,
                    2.18695928e-01,
                    6.62002005e-02,
                    8.81068392e-01,
                    8.15132226e-04,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    4.46286166e-02,
                    4.33166888e00,
                    1.89207090e-01,
                    2.93333228e-01,
                    7.84212470e-02,
                    2.83752898e-01,
                    8.54403195e-01,
                    8.60878436e-04,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    2.38094100e-01,
                    1.89207090e-01,
                    3.12872133e00,
                    1.10843611e00,
                    7.24769254e-01,
                    3.90823361e-01,
                    5.46263544e-01,
                    1.70440906e-03,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    1.57653632e-01,
                    2.93333228e-01,
                    1.10843611e00,
                    3.12872133e00,
                    3.90823361e-01,
                    7.24769254e-01,
                    5.46263544e-01,
                    1.70440906e-03,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    2.18695928e-01,
                    7.84212470e-02,
                    7.24769254e-01,
                    3.90823361e-01,
                    1.39661265e00,
                    1.50164883e-01,
                    3.27696035e-01,
                    8.81560519e-04,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    6.62002005e-02,
                    2.83752898e-01,
                    3.90823361e-01,
                    7.24769254e-01,
                    1.50164883e-01,
                    1.39661265e00,
                    3.27696035e-01,
                    8.81560519e-04,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    8.81068392e-01,
                    8.54403195e-01,
                    5.46263544e-01,
                    5.46263544e-01,
                    3.27696035e-01,
                    3.27696035e-01,
                    2.50139308e01,
                    4.90307127e-03,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    8.15132226e-04,
                    8.60878436e-04,
                    1.70440906e-03,
                    1.70440906e-03,
                    8.81560519e-04,
                    8.81560519e-04,
                    4.90307127e-03,
                    1.60392239e-05,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
            ],
            order="F",
        ),
    )

    vsbn_exp = np.array(0.0)
    vsoh_exp = np.array(-407.276949)

    pfcoil.vsec()

    assert_array_almost_equal(pfcoil_variables.vs_cs_pf_total_burn, vsbn_exp)
    assert_array_almost_equal(pfcoil_variables.vs_cs_total_pulse, vsoh_exp)


def test_hoop_stress(cs_coil, monkeypatch):
    """Test hoop_stress subroutine.

    hoop_stress() requires specific mocked variables in order to work; these were
    discovered using gdb to break on the first subroutine call when running the
    baseline 2018 IN.DAT.

    :param pfcoil: PFCoil object
    :type pfcoil: process.pfcoil.PFCoil
    :param monkeypatch: mocking fixture
    :type monkeypatch: _pytest.monkeypatch.MonkeyPatch
    """
    monkeypatch.setattr(pfcoil_variables, "f_a_cs_turn_steel", 0.57874999999999999)
    monkeypatch.setattr(pfcoil_variables, "b_cs_peak_pulse_start", 13.522197474024983)
    monkeypatch.setattr(pfcoil_variables, "j_cs_pulse_start", 19311657.760000002)
    monkeypatch.setattr(pfcoil_variables, "n_cs_pf_coils", 7)
    monkeypatch.setattr(
        pfcoil_variables,
        "r_pf_coil_outer",
        np.array([
            6.8520884119768697,
            6.9480065348448967,
            18.98258241468535,
            18.98258241468535,
            17.22166645654087,
            17.22166645654087,
            2.88462,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        ]),
    )
    monkeypatch.setattr(
        pfcoil_variables,
        "r_pf_coil_inner",
        np.array([
            5.6944236847973242,
            5.5985055619292972,
            17.819978201682968,
            17.819978201682968,
            16.385123084628962,
            16.385123084628962,
            2.3321999999999998,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        ]),
    )
    monkeypatch.setattr(tfv, "poisson_steel", 0.29999999999999999)

    r = 2.3
    s_hoop_exp = 6.737108e8
    s_hoop = cs_coil.hoop_stress(r)

    assert pytest.approx(s_hoop) == s_hoop_exp


def test_selfinductance(pfcoil):
    """Test selfinductance function.

    selfinductance() uses values discovered using gdb to break on the first
    function call when running the baseline 2018 IN.DAT.

    :param pfcoil: PFCoil object
    :type pfcoil: process.pfcoil.PFCoil
    """
    a = 2.6084100000000001
    b = 16.331562038811658
    c = 0.55242000000000013
    n = 4348.5468837135222
    selfinductance_exp = 2.501393e1

    selfinductance = pfcoil.selfinductance(a, b, c, n)
    assert pytest.approx(selfinductance) == selfinductance_exp


def test_brookscoil(pfcoil):
    """Unit test of self-inductance formula.

    :param pfcoil: PFCoil object
    :type pfcoil: process.pfcoil.PFCoil
    """
    c = 1.0e0
    a = 1.5e0 * c
    b = c
    n = 1.0e0

    l_self = 0.025491e0 * c * 100.0e0 * n**2 * 1.0e-6
    # Self-inductance of 1m Brooks coil: standard formula
    l_self_p = pfcoil.selfinductance(a, b, c, n)
    # Self-inductance of 1m Brooks coil: PROCESS formula

    assert (l_self / l_self_p < 1.05e0) and (l_self / l_self_p > 0.95e0)


@pytest.mark.parametrize(
    "z_tf_inside_half, f_z_cs_tf_internal, dr_cs, dr_bore, expected",
    [
        # Typical values
        (2.0, 0.5, 0.3, 0.15, (1.0, -1.0, 0.3, 0.3, 0.0, 0.45, 0.15, 0.6, 2.0, 0.9)),
        # Zero thickness
        (2.0, 0.5, 0.0, 0.0, (1.0, -1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.0, 0.0)),
        # Zero fractional height
        (2.0, 0.0, 0.3, 1.5, (0.0, -0.0, 1.65, 1.65, 0.0, 1.8, 1.5, 0.0, 0.0, 3.6)),
    ],
)
def test_calculate_cs_geometry(
    cs_coil, z_tf_inside_half, f_z_cs_tf_internal, dr_cs, dr_bore, expected
):
    result = cs_coil.calculate_cs_geometry(
        z_tf_inside_half=z_tf_inside_half,
        f_z_cs_tf_internal=f_z_cs_tf_internal,
        dr_cs=dr_cs,
        dr_bore=dr_bore,
    )
    assert pytest.approx(result) == expected


@pytest.mark.parametrize(
    "n_pf_coils_in_group, n_pf_group, r_cs_middle, dr_pf_cs_middle_offset, z_tf_inside_half, dr_tf_inboard, z_cs_coil_upper, expected_r, expected_z",
    [
        # Single coil, above CS
        (np.array([1, 0]), 0, 2.0, 0.1, 5.0, 0.2, 2.5, [2.1], [4.0]),
        # Two coils, above CS
        (np.array([2, 0]), 0, 3.0, 0.2, 6.0, 0.3, 3.0, [3.2, 3.2], [4.8, -4.8]),
        # Single coil, different offset
        (np.array([1, 0]), 0, 1.5, 0.05, 4.0, 0.1, 2.0, [1.55], [3.2]),
        # Two coils, different offset and heights
        (np.array([2, 0]), 0, 2.5, 0.15, 7.0, 0.25, 3.5, [2.65, 2.65], [5.525, -5.525]),
    ],
)
def test_place_pf_above_cs(
    pfcoil,
    n_pf_coils_in_group,
    n_pf_group,
    r_cs_middle,
    dr_pf_cs_middle_offset,
    z_tf_inside_half,
    dr_tf_inboard,
    z_cs_coil_upper,
    expected_r,
    expected_z,
):
    r_array, z_array = pfcoil.place_pf_above_cs(
        n_pf_coils_in_group=n_pf_coils_in_group,
        n_pf_group=n_pf_group,
        r_cs_middle=r_cs_middle,
        dr_pf_cs_middle_offset=dr_pf_cs_middle_offset,
        z_tf_inside_half=z_tf_inside_half,
        dr_tf_inboard=dr_tf_inboard,
        z_cs_coil_upper=z_cs_coil_upper,
    )
    # Only check the relevant group and number of coils
    n_coils = n_pf_coils_in_group[n_pf_group]
    assert_array_almost_equal(r_array[n_pf_group, :n_coils], expected_r)
    assert_array_almost_equal(z_array[n_pf_group, :n_coils], expected_z)


@pytest.mark.parametrize(
    "n_pf_coils_in_group, n_pf_group, rmajor, triang, rminor, itart, itartpf, z_tf_inside_half, dz_tf_upper_lower_midplane, z_tf_top, top_bottom, rpf2, zref, expected_r, expected_z, expected_top_bottom",
    [
        # Test case 1: ST configuration, coil above midplane
        (
            np.array([2, 2]),
            0,
            3.0,
            0.5,
            1.0,
            1,
            0,
            2.0,
            0.5,
            2.5,
            1,
            1.2,
            np.array([0.3, 0.4]),
            [3.6, 3.6],
            [1.7, -1.7],
            1,
        ),
        # Test case 2: Conventional configuration, coil above and below midplane
        (
            np.array([2, 2]),
            1,
            4.0,
            0.3,
            1.5,
            0,
            1,
            2.5,
            0.7,
            3.0,
            1,
            1.0,
            np.array([0.2, 0.5]),
            [4.45, 4.45],
            [3.86, -3.16],
            1,
        ),
    ],
)
def test_place_pf_above_tf(
    pfcoil,
    n_pf_coils_in_group,
    n_pf_group,
    rmajor,
    triang,
    rminor,
    itart,
    itartpf,
    z_tf_inside_half,
    dz_tf_upper_lower_midplane,
    z_tf_top,
    top_bottom,
    rpf2,
    zref,
    expected_r,
    expected_z,
    expected_top_bottom,
):
    r_arr, z_arr, top_bottom_out = pfcoil.place_pf_above_tf(
        n_pf_coils_in_group=n_pf_coils_in_group,
        n_pf_group=n_pf_group,
        rmajor=rmajor,
        triang=triang,
        rminor=rminor,
        itart=itart,
        itartpf=itartpf,
        z_tf_inside_half=z_tf_inside_half,
        dz_tf_upper_lower_midplane=dz_tf_upper_lower_midplane,
        z_tf_top=z_tf_top,
        top_bottom=top_bottom,
        rpf2=rpf2,
        zref=zref,
    )
    # Only check the relevant group and number of coils
    n_coils = n_pf_coils_in_group[n_pf_group]
    assert np.allclose(r_arr[n_pf_group, :n_coils], expected_r)
    assert np.allclose(z_arr[n_pf_group, :n_coils], expected_z)
    assert top_bottom_out == expected_top_bottom


def test_calculate_cs_turn_geometry_eu_demo_basic(cs_coil):
    # Typical values for a CS turn (arbitrary but physically reasonable)
    a_cs_turn = 0.02  # m^2
    f_dr_dz_cs_turn = 2.0
    radius_cs_turn_corners = 0.01  # m
    f_a_cs_turn_steel = 0.4

    (
        dz_cs_turn,
        dr_cs_turn,
        radius_cs_turn_cable_space,
        dr_cs_turn_conduit,
        dz_cs_turn_conduit,
    ) = cs_coil.calculate_cs_turn_geometry_eu_demo(
        a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel
    )

    # Check types and positivity
    assert isinstance(dz_cs_turn, float)
    assert isinstance(dr_cs_turn, float)
    assert isinstance(radius_cs_turn_cable_space, float)
    assert isinstance(dr_cs_turn_conduit, float)
    assert isinstance(dz_cs_turn_conduit, float)
    assert dz_cs_turn > 0
    assert dr_cs_turn > 0
    assert radius_cs_turn_cable_space > 0
    assert dr_cs_turn_conduit > 0
    assert dz_cs_turn_conduit > 0


@pytest.mark.parametrize(
    "a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel",
    [
        (0.01, 1.5, 0.0, 0.2),
    ],
)
def test_calculate_cs_turn_geometry_eu_demo_zero_corner(
    cs_coil, a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel
):
    # Test with zero corner radius
    (
        dz_cs_turn,
        dr_cs_turn,
        radius_cs_turn_cable_space,
        dr_cs_turn_conduit,
        dz_cs_turn_conduit,
    ) = cs_coil.calculate_cs_turn_geometry_eu_demo(
        a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel
    )
    assert dz_cs_turn > 0
    assert dr_cs_turn > 0
    assert radius_cs_turn_cable_space > 0


@pytest.mark.parametrize(
    "a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel",
    [
        (0.05, 10.0, 0.005, 0.05),
    ],
)
def test_calculate_cs_turn_geometry_eu_demo_high_aspect(
    cs_coil, a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel
):
    # High aspect ratio
    (
        dz_cs_turn,
        dr_cs_turn,
        radius_cs_turn_cable_space,
        dr_cs_turn_conduit,
        dz_cs_turn_conduit,
    ) = cs_coil.calculate_cs_turn_geometry_eu_demo(
        a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel
    )
    assert dr_cs_turn > dz_cs_turn
    assert radius_cs_turn_cable_space > 0


@pytest.mark.parametrize(
    "a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel",
    [
        (0.03, 2.5, 0.002, 0.15),
    ],
)
def test_calculate_cs_turn_geometry_eu_demo_output_consistency(
    cs_coil, a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel
):
    # Check that the sum of cable space and conduit thicknesses does not exceed half-width
    (
        dz_cs_turn,
        dr_cs_turn,
        radius_cs_turn_cable_space,
        dr_cs_turn_conduit,
        dz_cs_turn_conduit,
    ) = cs_coil.calculate_cs_turn_geometry_eu_demo(
        a_cs_turn, f_dr_dz_cs_turn, radius_cs_turn_corners, f_a_cs_turn_steel
    )
    # The cable space plus conduit thickness should not exceed half the turn width
    assert radius_cs_turn_cable_space + dz_cs_turn_conduit <= dz_cs_turn / 2 + 1e-8


def test_calculate_cs_self_peak_midplane_axial_stress_basic(cs_coil):
    # Typical values for a CS coil
    r_cs_outer = 2.0
    r_cs_inner = 1.5
    dz_cs_half = 1.0
    c_cs_peak = 1.2e7  # 12 MA

    s_axial, force_axial = cs_coil.calculate_cs_self_peak_midplane_axial_stress(
        r_cs_outer, r_cs_inner, dz_cs_half, c_cs_peak
    )

    # Check actual output numbers
    # These expected values should be updated if the implementation changes
    s_axial_exp = -40124020.69015699  # Example expected value, update as needed
    force_axial_exp = -110296662.5535968  # Example expected value, update as needed

    assert pytest.approx(s_axial, rel=1e-4) == s_axial_exp
    assert pytest.approx(force_axial, rel=1e-4) == force_axial_exp


def test_calculate_cs_self_peak_midplane_axial_stress_zero_current(cs_coil):
    # Zero current should yield zero force and stress
    r_cs_outer = 2.0
    r_cs_inner = 1.5
    dz_cs_half = 1.0
    c_cs_peak = 0.0

    s_axial, force_axial = cs_coil.calculate_cs_self_peak_midplane_axial_stress(
        r_cs_outer, r_cs_inner, dz_cs_half, c_cs_peak
    )

    assert pytest.approx(s_axial) == 0.0
    assert pytest.approx(force_axial) == 0.0


def test_calculate_cs_self_peak_midplane_axial_stress_extreme_geometry(cs_coil):
    # Very thin coil, large dz_cs_half
    r_cs_outer = 1.01
    r_cs_inner = 1.0
    dz_cs_half = 10.0
    c_cs_peak = 1.0e7

    s_axial, force_axial = cs_coil.calculate_cs_self_peak_midplane_axial_stress(
        r_cs_outer, r_cs_inner, dz_cs_half, c_cs_peak
    )

    # Check actual output numbers
    s_axial_exp = -15804019.29465635  # Example expected value, update as needed
    force_axial_exp = -498980.39867850166  # Example expected value, update as needed

    assert pytest.approx(s_axial, rel=1e-4) == s_axial_exp
    assert pytest.approx(force_axial, rel=1e-4) == force_axial_exp


def test_calculate_cs_self_peak_midplane_axial_stress_invalid(cs_coil):
    # Negative dz_cs_half should still return floats, but may be positive force
    r_cs_outer = 2.0
    r_cs_inner = 1.5
    dz_cs_half = 2.0
    c_cs_peak = 1.2e7

    s_axial, force_axial = cs_coil.calculate_cs_self_peak_midplane_axial_stress(
        r_cs_outer, r_cs_inner, dz_cs_half, c_cs_peak
    )

    # Check actual output numbers
    s_axial_exp = -16262350.341736654  # Example expected value, update as needed
    force_axial_exp = -44703470.31824042  # Example expected value, update as needed

    assert pytest.approx(s_axial, rel=1e-4) == s_axial_exp
    assert pytest.approx(force_axial, rel=1e-4) == force_axial_exp
